{% set blockColor = 'white' %}
{% set hasBlockColorChange = false %}
{# Check if any blockColorChanges #}
{% for block in entry.projectBlocks.all() %}
  {% if block.type == 'blockColorChange' %}
    {% set hasBlockColorChange = true %}
    {% if loop.index == 1 %}
      {# Check if first block is a color change and set initial block-color to that #}
      {% set blockColor = entry.projectBlocks[0].color %}
    {% else %}
{% endif %}

  {% endif %}
{% endfor %}

{# Only init block-color if project has any color changes #}
{% if hasBlockColorChange %}<div class="block-color color-{{ blockColor }}"><div class="block-wrap">{% endif %}

{% for block in entry.projectBlocks.all() %}
  {% switch block.type %}

    {% case "blockColorChange" %}
      {% if blockColor != block.color %}
        {% set blockColor = block.color %}
        </div></div>
        <div data-id="55" class="block-color color-{{ block.color }}"><div class="block-wrap">
      {% endif %}

    {% case "blockHeader" %}
      <div class="project-summary user-content">
        {% if block.numberHeader %}
          <h3 class="h1 number-header">{{ block.numberHeader }}</h3>
        {% endif %}
        {% if block.blockTitle %}
          <h2>{{ block.blockTitle }}</h2>
        {% endif %}
        {{ block.blockDescription }}
      </div>

    {% case "blockTypeSpecimen" %}
      </div><!-- /.block-wrap -->
      {% set colorPairs = '' %}
      {% if block.colors | length %}
        {% set colorPairsArray = [] %}
        {% for colorPair in block.colors %}
          {% set colorPairVals = [colorPair.textColor, colorPair.backgroundColor]|filter|join('-') %}
          {% set colorPairsArray = colorPairsArray|merge([colorPairVals]) %}
        {% endfor %}
        {% set colorPairs = colorPairsArray|join(' ') %}
      {% endif %}
      <div id="{{ block.fontName }}" class="type-tester" data-font="{{ block.fontName }}" data-styles="" data-font-size="{{ block.startingFontSize }}" data-line-height="{{ block.lineHeight }}" data-glyphs-line-height="{{ block.glyphsLineHeight ? block.glyphsLineHeight : '1' }}" data-min-size="{{ block.minFontSize }}" data-max-size="{{ block.maxFontSize }}" data-color-pairs="{{ colorPairs }}" data-svg-url="{{ craft.config.cdnUrl }}{{ block.svgFontFile[0].getUrl() }}">
        <style>
          @font-face {
            font-family: '{{ block.fontName }}';
            src: url('{{ craft.config.cdnUrl }}{{ block.woffFontFile[0].getUrl() }}') format('woff'),
                 url('{{ craft.config.cdnUrl }}{{ block.svgFontFile[0].getUrl() }}') format('svg');
            font-weight: normal;
            font-style: normal;
          }
          {% include "partials/_blank-font-face" %}
        </style>
        <div class="type-tester-inner">
          <div id="test-para" class="test-para block-wrap -active" contenteditable="true">
            {% if block.sampleText %}
              {{ block.sampleText }}<span class="type-cursor"></span>
            {% else %}
              Start typing here to test font lorem ipsum dolor sit amet, consectetur adipisicing elit. Earum accusantium laboriosam velit distinctio atque eius rerum necessitatibus in doloribus nemo aspernatur, aut, blanditiis debitis numquam saepe ab neque repellat tenetur.<span class="type-cursor"></span>
            {% endif %}
          </div>
        </div>
      </div>
    {% case "blockImages" %}
      </div><!-- /.block-wrap -->
      <div class="fullbleed-images">
        {% if block.carousel %}
          <div class="flickity js-cursor">
            {% for image in block.images.all() %}
              {% set treatedImage = craft.imager.transformImage(image, { mode: 'fit', width: 1800, height: 900 }) %}
              {% set orientation = image.getWidth() > image.getHeight() ? 'landscape' : 'portrait' %}
              <div class="slide {{ orientation }}">
                {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}
                  <img src="{{ craft.app.config.general.cdnUrl }}{{ treatedImage.getUrl() }}" alt="{{ image.title }}"></div>
                {%- if block.imageLinkUrl %}</a>{% endif -%}
            {% endfor %}
          </div>
        {% else %}
          {% for image in block.images.all() %}
            {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}
              <p><img class="lazy" src="{{ rev('images/gray.gif') }}" data-original="{{ craft.app.config.general.cdnUrl }}{{ image.getUrl() }}" alt="{{ image.title }}"></p>
            {%- if block.imageLinkUrl %}</a>{% endif -%}
          {% endfor %}
        {% endif %}
      </div>
      <div class="block-wrap">
    {% case "blockHtml" %}
      <div class="block-html">{{ block.html }}</div>

    {% case "blockText" %}
      <div class="block-text user-content {{ block.size }}">{{ block.text }}</div>

    {% case "blockPaddedImage" %}
      {% for image in block.image.all() %}
        {% set width = (block.size == 'halfWidth' ? 900 : 1800) %}
        {% if block.treated %}
          {% set treatedImage = craft.imager.transformImage(image, { width: width, effects: { modulate: [100, 0, 100], clut: 'gradient:#000000-#ffffff' } }) %}
        {% else %}
          {% set treatedImage = craft.imager.transformImage(image, { width: width }) %}
        {% endif %}

        <div data-id="54" class="block-image {{ block.size }}">
          {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}
            <img class="lazy" src="{{ rev('images/gray.gif') }}" data-original="{{ craft.app.config.general.cdnUrl }}{{ treatedImage.getUrl() }}" alt="{{ image.title }}">
          {%- if block.imageLinkUrl %}</a>{% endif -%}
        </div>
      {% endfor %}

    {% case "blockQuote" %}
        <div class="block-quote" style="color: {{ block.textColor }}; background-color: {{ block.backgroundColor }};">
          <blockquote>{{ block.quote }}</blockquote>
        </div>

    {% default %}
      Hello?

  {% endswitch %}
{% endfor %}

{% if hasBlockColorChange %}</div></div><!-- /.block-wrap/.block-color -->{% endif %}
