{% set blockColor = 'white' %}
{% set hasBlockColorChange = false %}
{# Check if any blockColorChanges #}
{% for block in entry.projectBlocks.all() %}
  {% if block.type == 'blockColorChange' %}
    {% set hasBlockColorChange = true %}
    {% if loop.index == 1 %}
      {# Check if first block is a color change and set initial block-color to that #}
      {% set blockColor = entry.projectBlocks[0].color %}
    {% endif %}
  {% endif %}
{% endfor %}

{# Only init block-color if project has any color changes #}
{% if hasBlockColorChange %}<div class="block-color color-{{ blockColor }}"><div class="block-wrap">{% endif %}

{% for block in entry.projectBlocks.all() %}
  {% set loopIndex = loop.index - 1 %}

  {% switch block.type %}

    {% case "blockColorChange" %}
      {% if blockColor != block.color %}
        {% set blockColor = block.color %}
        </div></div>
        <div class="block-color color-{{ block.color }}"><div class="block-wrap">
      {% elseif loopIndex > 1 %}
        <div class="block"><div class="block-wrap">
      {% endif %}


    {% case "blockHeader" %}
      <div class="project-summary user-content">
        {% if block.numberHeader %}
          <h3 class="h1 number-header">{{ block.numberHeader }}</h3>
        {% endif %}
        {% if block.blockTitle %}
          <h2>{{ block.blockTitle }}</h2>
        {% endif %}
        {{ block.blockDescription }}
      </div>

    {% case "blockTypeSpecimen" %}
      </div><!-- /.block-wrap -->
      {% set colorPairs = '' %}
      {% if block.colors | length %}
        {% set colorPairsArray = [] %}
        {% for colorPair in block.colors %}
          {% set colorPairVals = [colorPair.textColor, colorPair.backgroundColor]|filter|join('-') %}
          {% set colorPairsArray = colorPairsArray|merge([colorPairVals]) %}
        {% endfor %}
        {% set colorPairs = colorPairsArray|join(' ') %}
      {% endif %}
      <div id="{{ block.fontName }}" class="type-tester" data-font="{{ block.fontName }}" data-font-size="{{ block.startingFontSize }}" data-line-height="{{ block.lineHeight }}" data-min-size="{{ block.minFontSize }}" data-max-size="{{ block.maxFontSize }}" data-color-pairs="{{ colorPairs }}" data-svg-url="{{ craft.app.config.general.cdnUrl }}{{ block.svgFontFile[0].getUrl() }}" data-initial-alignment="{{ block.initialAlignment }}">
        <style>
          @font-face {
            font-family: '{{ block.fontName }}';
            src: url('{{ craft.app.config.general.cdnUrl }}{{ block.woffFontFile[0].getUrl() }}') format('woff'),
                 url('{{ craft.app.config.general.cdnUrl }}{{ block.svgFontFile[0].getUrl() }}') format('svg');
            font-weight: normal;
            font-style: normal;
          }
          {% include "partials/_blank-font-face" %}
        </style>
        <div class="type-tester-inner">
          <div id="test-para" class="test-para block-wrap{{ block.initialView == 'typeTester' ? ' -active' : '' }}" contenteditable="true">
            {% if block.sampleText %}
              {{ block.sampleText }}<span class="type-cursor"></span>
            {% else %}
              Start typing here to test font lorem ipsum dolor sit amet, consectetur adipisicing elit. Earum accusantium laboriosam velit distinctio atque eius rerum necessitatibus in doloribus nemo aspernatur, aut, blanditiis debitis numquam saepe ab neque repellat tenetur.<span class="type-cursor"></span>
            {% endif %}
          </div>
          {% if block.svgFontFile[0] %}
            <div id="typeTesterSvgFont" style="display:none;"></div>
            <div id="glyphChart" class="block-wrap{{ block.initialView == 'glyphsChart' ? ' -active' : '' }}" style="font-family:{{ block.fontName }};font-size: {{ block.startingFontSize }}px;line-height:{{ block.glyphsLineHeight ? block.glyphsLineHeight : '1' }};">
              <ul id="glyphsLowercase"></ul>
              <ul id="glyphsUppercase"></ul>
              <ul id="glyphsOther"></ul>
            </div>
          {% endif %}
        </div>
      </div>
      {% if loopIndex + 1 < entry.projectBlocks.all()|length and entry.projectBlocks.all()[loopIndex + 1].type != "blockColorChange" %}
      <div class="block-wrap">
      {% endif %}

    {% case "blockImages" %}
      </div><!-- /.block-wrap -->
      <div class="fullbleed-images">
        {% if block.carousel %}
          <div class="flickity js-cursor">
            {% for image in block.images.all() %}
              {% set treatedImage = craft.imager.transformImage(image, { mode: 'fit', width: 1800, height: 900 }) %}
              {% set orientation = image.getWidth() > image.getHeight() ? 'landscape' : 'portrait' %}
              <div class="slide {{ orientation }}">
                {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}
                  <img src="{{ craft.app.config.general.cdnUrl }}{{ treatedImage.getUrl() }}" alt="{{ image.title }}"></div>
                {%- if block.imageLinkUrl %}</a>{% endif -%}
            {% endfor %}
          </div>
        {% else %}
          {% for image in block.images.all() %}
            {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}
              <p><img class="lazy" src="{{ rev('images/gray.gif') }}" data-original="{{ craft.app.config.general.cdnUrl }}{{ image.getUrl() }}" alt="{{ image.title }}"></p>
            {%- if block.imageLinkUrl %}</a>{% endif -%}
          {% endfor %}
        {% endif %}
      </div>
      {% if loopIndex + 1 < entry.projectBlocks.all()|length and entry.projectBlocks.all()[loopIndex + 1].type != "blockColorChange" %}
      <div class="block-wrap">
      {% endif %}

    {% case "blockHtml" %}
      <div class="block-html">{{ block.html }}</div>

    {% case "blockText" %}
      <div class="block-text user-content {{ block.size }}">{{ block.text }}</div>

    {% case "blockPaddedImage" %}
      {% for image in block.image.all() %}
        {% set width = (block.size == 'halfWidth' ? 900 : 1800) %}
        {% if block.treated %}
          {% set treatedImage = craft.imager.transformImage(image, { width: width, effects: { modulate: [100, 0, 100], clut: 'gradient:#000000-#ffffff' } }) %}
        {% else %}
          {% if image.filename matches '/gif$/' %}
            {% set treatedImage = image %}
          {% else %}
            {% set treatedImage = craft.imager.transformImage(image, { width: width }) %}
          {% endif %}
        {% endif %}
        <div data-id="54" class="block-image {{ block.size }}{{ block.size == 'halfWidth' and block.allowZoom ? ' lightbox' : '' }}">
          {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}
            <img class="lazy" src="{{ rev('images/gray.gif') }}" data-original="{{ craft.app.config.general.cdnUrl }}{{ treatedImage.getUrl() }}" alt="{{ image.title }}">
          {%- if block.imageLinkUrl %}</a>{% endif -%}

          {% if block.text and loop.last %}
            <div class="block-text user-content">
              {{ block.text }}
            </div>
          {% endif %}
        </div>
      {% endfor %}

    {% case "blockQuote" %}
        <div class="block-quote" style="color: {{ block.textColor }}; background-color: {{ block.backgroundColor }};">
          <blockquote>{{ block.quote }}</blockquote>
        </div>

    {% default %}
      Hello?

  {% endswitch %}
{% endfor %}

{% if hasBlockColorChange %}</div></div><!-- /.block-wrap/.block-color -->{% endif %}
